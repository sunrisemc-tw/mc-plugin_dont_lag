# 自動村民優化系統詳細指南

## 📖 概述

自動村民優化系統是 DontLag 插件的核心功能之一，專門為解決大型村民交易所的卡頓問題而設計。

## 🎯 設計理念

### 問題背景
在大型 Minecraft 伺服器中，村民交易所通常會聚集大量村民（20-100隻），這些村民的 AI 計算會嚴重影響伺服器性能：
- **代理系統（Gossip）**：村民之間會互相傳遞訊息
- **尋路系統**：村民會不斷尋找工作站和床
- **記憶系統**：村民會記住玩家、位置等信息
- **社交行為**：村民會互相交流、聚集

### 解決方案
自動優化系統採用以下策略避免大量計算：

1. **區塊分組**：將村民按 Chunk（16x16）分組追蹤
2. **事件驅動**：只在村民生成/移除時檢查
3. **異步檢查**：定時任務在異步線程執行
4. **智能緩存**：使用 ConcurrentHashMap 減少鎖競爭
5. **永久優化**：優化後不會自動恢復，避免重複計算

## ⚙️ 配置說明

```yaml
auto-optimize:
  enabled: true          # 是否啟用
  threshold: 5           # 閾值（隻/區塊）
  check-interval: 30     # 檢查間隔（秒）
```

### 參數詳解

#### `enabled` - 啟用狀態
- `true`：啟用自動優化（推薦）
- `false`：停用自動優化

#### `threshold` - 村民數量閾值
建議值：3-10 隻

| 閾值 | 適用場景 | 說明 |
|-----|---------|------|
| 3 | 極端優化 | 任何有3隻以上村民的區塊都優化 |
| 5 | 標準配置 | 推薦用於大多數伺服器 |
| 8 | 寬鬆模式 | 允許較多村民保持正常行為 |
| 10+ | 最小干預 | 只優化超大型交易所 |

#### `check-interval` - 檢查間隔
建議值：20-60 秒

| 間隔 | CPU 影響 | 響應速度 |
|------|---------|---------|
| 10-20秒 | 較高 | 非常快 |
| 30秒 | 低（推薦） | 快 |
| 45-60秒 | 極低 | 一般 |

## 🔧 工作流程

### 1. 初始化階段
```
插件啟動 → 掃描所有已加載的村民 → 建立追蹤表
```

### 2. 運行時追蹤
```
村民生成 → 添加到對應區塊 → 檢查是否超過閾值 → 自動優化
村民移除 → 從追蹤表移除 → 更新統計
```

### 3. 定時檢查（異步）
```
每 N 秒 → 檢查所有區塊 → 清理無效數據 → 優化超標區塊
```

## 📊 性能數據

### 測試環境
- **伺服器**：Paper 1.20.1
- **配置**：i7-9700K, 16GB RAM
- **村民數量**：80隻（4個區塊，每個20隻）

### 優化前
- **TPS**：14-16
- **CPU 使用率**：75-85%
- **村民 AI Tick**：~800ms

### 優化後
- **TPS**：19-20
- **CPU 使用率**：35-45%
- **村民 AI Tick**：~50ms
- **效能提升**：約 **85%**

## 🎮 使用建議

### 大型村民交易所（推薦配置）
```yaml
auto-optimize:
  enabled: true
  threshold: 5
  check-interval: 30
```

這個配置會：
- ✅ 自動優化任何擁有 5+ 村民的區塊
- ✅ 每 30 秒檢查一次
- ✅ 永久優化，不會恢復
- ✅ 完全保留交易和補貨功能

### 小型/中型伺服器
```yaml
auto-optimize:
  enabled: true
  threshold: 8
  check-interval: 45
```

### 只想手動控制
```yaml
auto-optimize:
  enabled: false
```
停用自動優化，使用 `/delag villager set` 手動優化

## ❓ 常見問題

### Q: 自動優化會影響村民交易嗎？
**A**: 不會！優化只移除尋路、代理等功能，完全保留交易和補貨。

### Q: 優化後的村民會恢復嗎？
**A**: 不會。自動優化是永久的，重啟後仍然生效。這是為了避免重複計算。

### Q: 如何知道哪些村民被優化了？
**A**: 使用 `/delag info` 查看統計資訊。

### Q: 會不會一直檢查導致卡頓？
**A**: 不會。檢查任務是異步的，而且只在村民生成/移除時才會觸發主要檢查。

### Q: 我的村民數量沒有超過閾值但還是卡？
**A**: 可以降低閾值，或使用 `/delag villager set` 手動優化。

### Q: 可以排除某些區塊嗎？
**A**: 目前版本不支持，但可以通過提高閾值來減少優化範圍。

## 🔍 監控與調優

### 查看統計資訊
```
/delag info
```

顯示：
- 追蹤的區塊數
- 追蹤的村民總數
- 永久優化的村民數
- 當前閾值設定

### 調整參數
1. 修改 `config.yml`
2. 執行 `/delag reload`
3. 觀察 `/delag info` 的變化

### 性能指標

**正常情況**：
- 追蹤區塊數應該穩定
- 永久優化數緩慢增長
- TPS 穩定在 19-20

**需要調整**：
- TPS < 18：降低閾值
- 太多村民被優化：提高閾值
- 檢查頻繁導致卡頓：增加檢查間隔

## 🛠️ 技術細節

### 資料結構
```java
ConcurrentHashMap<String, Set<UUID>> chunkVillagers
// Key: "世界名:區塊X:區塊Z"
// Value: 該區塊的村民 UUID 集合

ConcurrentHashSet<UUID> permanentlyOptimized
// 永久優化的村民 UUID
```

### 線程安全
- 使用 `ConcurrentHashMap` 和 `ConcurrentHashSet`
- 異步任務只讀取數據
- 優化操作在主線程執行

### 記憶體使用
每個追蹤的村民約使用：
- UUID: 16 bytes
- 區塊鍵: ~40 bytes
- 總計: ~60 bytes/村民

1000 隻村民約使用 60KB 記憶體（可忽略不計）

## 📈 最佳實踐

1. **初次使用**：使用預設配置（閾值5，間隔30秒）
2. **觀察 TPS**：運行 1-2 天，觀察性能變化
3. **調整參數**：根據實際情況微調
4. **定期檢查**：每週查看一次 `/delag info`
5. **備份配置**：找到最佳配置後備份

## 💡 提示

- 自動優化特別適合**固定位置的交易村民**
- 如果有**移動的村民**，建議提高閾值或停用
- 結合手動工具使用效果更佳
- 定期重啟伺服器以清理無效數據

## 📞 支援

遇到問題？
1. 檢查配置是否正確
2. 查看伺服器日誌
3. 在 [GitHub Issues](https://github.com/sunrisemc-tw/mc-plugin_dont_lag/issues) 回報

